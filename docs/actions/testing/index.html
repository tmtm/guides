<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="Actions: Testing | Hanami Guides" />

    <meta property="og:url"          content="https://tmtm.github.io/hanami-guides/actions/testing/" />
    <meta property="og:type"         content="article" />
    <meta property="og:locale"       content="en_US" />
    <meta property="og:site_name"    content="Hanami Guides" />
    <meta property="og:title"        content="Actions: Testing | Hanami Guides" />
    <meta property="og:description"  content="Actions: Testing | Hanami Guides" />
    <meta property="og:image"        content="https://tmtm.github.io/assets/img/brand/hanami-guides-social.png" />
    <meta property="og:image:type"   content="image/png" />
    <meta property="og:image:width"  content="2968" />
    <meta property="og:image:height" content="2968" />
    <meta property="og:image:alt"    content="" />

    <meta name="twitter:card"        content="summary" />
    <meta name="twitter:site"        content="@hanamirb" />
    <meta name="twitter:creator"     content="@hanamirb" />
    <meta name="twitter:title"       content="Actions: Testing | Hanami Guides" />
    <meta name="twitter:description" content="Actions: Testing | Hanami Guides" />
    <meta name="twitter:image"       content="https://tmtm.github.io/assets/img/brand/hanami-guides-social.png" />

    <title>Actions: Testing | Hanami Guides</title>

    <meta name="author" content="Hanami team">
    <meta name="keywords" content="hanami,hanamirb,hanami guides,documentation,lotus,lotusrb,web,framework,ruby,open source,oss,os,software,free,free software,architecture,fast,lightweight,testing,tdd,bdd,test driven development,behaviour driven development,full stack,mvc,model view object,pattern,patterns,design patterns,oop,object oriented programming,testability,http,https,routing,router,http router,restful,resource,resources,convention,controller,models,repository,query,sql,interactors,two-step view,view,template,presenters,render,rendering,helpers,erb,haml,tilt,json,xml,yaml,yml,framwork,framewrok,riby,free sowftare" />
    
    <link rel="shortcut icon" href="/hanami-guides/assets/img/brand/favicon.ico">
    
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600,700" rel="stylesheet">
    
    <link href="/hanami-guides/assets/vendor/nucleo/css/nucleo.css" rel="stylesheet">
    <link href="/hanami-guides/assets/vendor/font-awesome/css/font-awesome.min.css" rel="stylesheet">
    
    <link type="text/css" href="/hanami-guides/assets/css/argon.css?v=1.0.1" rel="stylesheet">
    
    <link type="text/css" href="/hanami-guides/assets/css/docs.min.css" rel="stylesheet">
    
    <link type="text/css" href="/hanami-guides/assets/css/theme.css" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css" />
  </head>
  <body data-spy="scroll" data-target="#secondary-navigation" data-offset="50">
    <header class="navbar navbar-expand navbar-dark flex-row align-items-md-center ct-navbar">
      <a class="navbar-brand mr-0 mr-md-2" href="/hanami-guides/" aria-label="Bootstrap">
      <img src="/hanami-guides/assets/img/brand/white.png" alt="Hanami guides logo">
    </a>
    <ul class="navbar-nav flex-row mr-auto ml-4 d-none d-md-flex">
      <li class="nav-item">
        <form>
          <input type="text" placeholder="Search" class="form-control" id="search-input" />
        </form>
      </li>
    </ul>
    <div class="d-none d-sm-block ml-auto">
      <ul class="navbar-nav ct-navbar-nav flex-row align-items-center">
        <li class="nav-item">
          <a class="nav-link nav-link-icon" href="http://hanamirb.org" target="_blank" title="Hanami website">
            <i class="ni ni-world"></i>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link nav-link-icon" href="https://github.com/hanami/guides/edit//content/actions/testing.md" target="_blank" title="Edit this page">
            <i class="fa fa-pencil-square-o"></i>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link nav-link-icon" href="https://github.com/hanami/hanami" target="_blank" title="Star Hanami on GitHub">
            <i class="fa fa-github"></i>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link nav-link-icon" href="https://twitter.com/hanamirb" target="_blank" title="Follow Hanami on Twitter">
            <i class="fa fa-twitter"></i>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link nav-link-icon" href="https://www.facebook.com/hanamirb" target="_blank" title="Like Hanami on Facebook">
            <i class="fa fa-facebook-square"></i>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link nav-link-icon" href="https://www.instagram.com/hanamirb" target="_blank" title="Follow Hanami on Instagram">
            <i class="fa fa-instagram"></i>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link nav-link-icon" href="http://chat.hanamirb.org/" target="_blank" title="Hanami chat">
            <i class="ni ni-chat-round"></i>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link nav-link-icon" href="https://github.com/hanami/guides/releases" target="_blank" title="Download Hanami Guides for offline usage">
            <i class="fa fa-cloud-download"></i>
          </a>
        </li>
        <li class="nav-item">
          <span class="badge badge-pill badge-primary">v1.3.1</span>
        </li>
      </ul>
    </div>
  </header>
  <div class="container-fluid">
    <div class="row flex-xl-nowrap">
      <div class="col-12 col-md-3 col-xl-2 ct-sidebar">
        <nav class="collapse ct-links" id="ct-docs-nav">
          
          <div class="ct-toc-item active">
          
          
            <span class="ct-toc-link">Introduction</span>
            <ul class="nav ct-sidenav">
            
              
              <li>
              
                <a href="/hanami-guides/introduction/getting-started/">はじめに</a>
              </li>
            
            </ul>
          
          
            <span class="ct-toc-link">Architecture</span>
            <ul class="nav ct-sidenav">
            
              
              <li>
              
                <a href="/hanami-guides/architecture/overview/">概要</a>
              </li>
            
              
              <li>
              
                <a href="/hanami-guides/architecture/interactors/">インタラクター</a>
              </li>
            
            </ul>
          
          
            <span class="ct-toc-link">Projects</span>
            <ul class="nav ct-sidenav">
            
              
              <li>
              
                <a href="/hanami-guides/projects/code-reloading/">コードのリロード</a>
              </li>
            
              
              <li>
              
                <a href="/hanami-guides/projects/rake/">Rakeタスク</a>
              </li>
            
              
              <li>
              
                <a href="/hanami-guides/projects/logging/">ロギング</a>
              </li>
            
              
              <li>
              
                <a href="/hanami-guides/projects/initializers/">イニシャライザ</a>
              </li>
            
              
              <li>
              
                <a href="/hanami-guides/projects/rack-middleware/">Rackミドルウェア</a>
              </li>
            
              
              <li>
              
                <a href="/hanami-guides/projects/security/">プロジェクトセキュリティ</a>
              </li>
            
              
              <li>
              
                <a href="/hanami-guides/projects/http2-early-hints/">HTTP/2 Early Hints</a>
              </li>
            
              
              <li>
              
                <a href="/hanami-guides/projects/selectively-boot-apps/">アプリを選択的に起動する</a>
              </li>
            
            </ul>
          
          
            <span class="ct-toc-link">Routing</span>
            <ul class="nav ct-sidenav">
            
              
              <li>
              
                <a href="/hanami-guides/routing/overview/">Overview</a>
              </li>
            
              
              <li>
              
                <a href="/hanami-guides/routing/basic-usage/">Basic Usage</a>
              </li>
            
              
              <li>
              
                <a href="/hanami-guides/routing/restful-resources/">RESTful Resource(s)</a>
              </li>
            
              
              <li>
              
                <a href="/hanami-guides/routing/testing/">Testing</a>
              </li>
            
            </ul>
          
          
            <span class="ct-toc-link">Actions</span>
            <ul class="nav ct-sidenav">
            
              
              <li>
              
                <a href="/hanami-guides/actions/overview/">Overview</a>
              </li>
            
              
              <li>
              
                <a href="/hanami-guides/actions/basic-usage/">Basic Usage</a>
              </li>
            
              
              <li>
              
                <a href="/hanami-guides/actions/parameters/">Parameters</a>
              </li>
            
              
              <li>
              
                <a href="/hanami-guides/actions/request-and-response/">Request &amp; Response</a>
              </li>
            
              
              <li>
              
                <a href="/hanami-guides/actions/exposures/">Exposures</a>
              </li>
            
              
              <li>
              
                <a href="/hanami-guides/actions/rack-integration/">Rack Integration</a>
              </li>
            
              
              <li>
              
                <a href="/hanami-guides/actions/mime-types/">MIME Types</a>
              </li>
            
              
              <li>
              
                <a href="/hanami-guides/actions/cookies/">Cookies</a>
              </li>
            
              
              <li>
              
                <a href="/hanami-guides/actions/sessions/">Sessions</a>
              </li>
            
              
              <li>
              
                <a href="/hanami-guides/actions/exception-handling/">Exception Handling</a>
              </li>
            
              
              <li>
              
                <a href="/hanami-guides/actions/control-flow/">Control Flow</a>
              </li>
            
              
              <li>
              
                <a href="/hanami-guides/actions/http-caching/">HTTP Caching</a>
              </li>
            
              
              <li>
              
                <a href="/hanami-guides/actions/share-code/">Share Code</a>
              </li>
            
              
              <li class="active ct-sidenav-active">
              
                <a href="/hanami-guides/actions/testing/">Testing</a>
              </li>
            
            </ul>
          
          
            <span class="ct-toc-link">Views</span>
            <ul class="nav ct-sidenav">
            
              
              <li>
              
                <a href="/hanami-guides/views/overview/">Overview</a>
              </li>
            
              
              <li>
              
                <a href="/hanami-guides/views/basic-usage/">Basic Usage</a>
              </li>
            
              
              <li>
              
                <a href="/hanami-guides/views/templates/">Templates</a>
              </li>
            
              
              <li>
              
                <a href="/hanami-guides/views/mime-types/">MIME Types</a>
              </li>
            
              
              <li>
              
                <a href="/hanami-guides/views/layouts/">Layouts</a>
              </li>
            
              
              <li>
              
                <a href="/hanami-guides/views/custom-error-pages/">Custom Error Pages</a>
              </li>
            
              
              <li>
              
                <a href="/hanami-guides/views/share-code/">Share Code</a>
              </li>
            
              
              <li>
              
                <a href="/hanami-guides/views/testing/">Testing</a>
              </li>
            
            </ul>
          
          
            <span class="ct-toc-link">Models</span>
            <ul class="nav ct-sidenav">
            
              
              <li>
              
                <a href="/hanami-guides/models/overview/">Overview</a>
              </li>
            
              
              <li>
              
                <a href="/hanami-guides/models/database-configuration/">Database Configuration</a>
              </li>
            
              
              <li>
              
                <a href="/hanami-guides/models/use-your-own-orm/">Use Your Own ORM</a>
              </li>
            
            </ul>
          
          
            <span class="ct-toc-link">Repositories</span>
            <ul class="nav ct-sidenav">
            
              
              <li>
              
                <a href="/hanami-guides/repositories/overview/">Overview</a>
              </li>
            
              
              <li>
              
                <a href="/hanami-guides/repositories/sql-queries/">SQL Queries</a>
              </li>
            
              
              <li>
              
                <a href="/hanami-guides/repositories/postgresql/">PostgreSQL</a>
              </li>
            
            </ul>
          
          
            <span class="ct-toc-link">Entities</span>
            <ul class="nav ct-sidenav">
            
              
              <li>
              
                <a href="/hanami-guides/entities/overview/">Overview</a>
              </li>
            
              
              <li>
              
                <a href="/hanami-guides/entities/custom-schema/">Custom Schema</a>
              </li>
            
              
              <li>
              
                <a href="/hanami-guides/entities/data-types/">Data Types</a>
              </li>
            
            </ul>
          
          
            <span class="ct-toc-link">Associations</span>
            <ul class="nav ct-sidenav">
            
              
              <li>
              
                <a href="/hanami-guides/associations/overview/">Overview</a>
              </li>
            
              
              <li>
              
                <a href="/hanami-guides/associations/has-many/">Has Many</a>
              </li>
            
              
              <li>
              
                <a href="/hanami-guides/associations/belongs-to/">Belongs To</a>
              </li>
            
              
              <li>
              
                <a href="/hanami-guides/associations/has-one/">Has One</a>
              </li>
            
              
              <li>
              
                <a href="/hanami-guides/associations/has-many-through/">Has Many Through</a>
              </li>
            
            </ul>
          
          
            <span class="ct-toc-link">Migrations</span>
            <ul class="nav ct-sidenav">
            
              
              <li>
              
                <a href="/hanami-guides/migrations/overview/">Migrations</a>
              </li>
            
              
              <li>
              
                <a href="/hanami-guides/migrations/create-table/">Create Table</a>
              </li>
            
              
              <li>
              
                <a href="/hanami-guides/migrations/alter-table/">Alter Table</a>
              </li>
            
            </ul>
          
          
            <span class="ct-toc-link">Validations</span>
            <ul class="nav ct-sidenav">
            
              
              <li>
              
                <a href="/hanami-guides/validations/overview/">Overview</a>
              </li>
            
              
              <li>
              
                <a href="/hanami-guides/validations/boolean-logic/">Boolean Logic</a>
              </li>
            
              
              <li>
              
                <a href="/hanami-guides/validations/custom-predicates/">Custom Predicates</a>
              </li>
            
              
              <li>
              
                <a href="/hanami-guides/validations/advanced-usage/">Advanced Usage</a>
              </li>
            
            </ul>
          
          
            <span class="ct-toc-link">Helpers</span>
            <ul class="nav ct-sidenav">
            
              
              <li>
              
                <a href="/hanami-guides/helpers/overview/">Overview</a>
              </li>
            
              
              <li>
              
                <a href="/hanami-guides/helpers/html5/">HTML5</a>
              </li>
            
              
              <li>
              
                <a href="/hanami-guides/helpers/forms/">Forms</a>
              </li>
            
              
              <li>
              
                <a href="/hanami-guides/helpers/routing/">Routing</a>
              </li>
            
              
              <li>
              
                <a href="/hanami-guides/helpers/assets/">Assets</a>
              </li>
            
              
              <li>
              
                <a href="/hanami-guides/helpers/links/">Links</a>
              </li>
            
              
              <li>
              
                <a href="/hanami-guides/helpers/escape/">Markup Escape</a>
              </li>
            
              
              <li>
              
                <a href="/hanami-guides/helpers/numbers/">Numbers</a>
              </li>
            
              
              <li>
              
                <a href="/hanami-guides/helpers/custom-helpers/">Custom Helpers</a>
              </li>
            
            </ul>
          
          
            <span class="ct-toc-link">Mailers</span>
            <ul class="nav ct-sidenav">
            
              
              <li>
              
                <a href="/hanami-guides/mailers/overview/">Overview</a>
              </li>
            
              
              <li>
              
                <a href="/hanami-guides/mailers/basic-usage/">Basic Usage</a>
              </li>
            
              
              <li>
              
                <a href="/hanami-guides/mailers/templates/">Templates</a>
              </li>
            
              
              <li>
              
                <a href="/hanami-guides/mailers/delivery/">Delivery</a>
              </li>
            
              
              <li>
              
                <a href="/hanami-guides/mailers/share-code/">Share Code</a>
              </li>
            
              
              <li>
              
                <a href="/hanami-guides/mailers/testing/">Testing</a>
              </li>
            
            </ul>
          
          
            <span class="ct-toc-link">Assets</span>
            <ul class="nav ct-sidenav">
            
              
              <li>
              
                <a href="/hanami-guides/assets/overview/">Overview</a>
              </li>
            
              
              <li>
              
                <a href="/hanami-guides/assets/preprocessors/">Preprocessors</a>
              </li>
            
              
              <li>
              
                <a href="/hanami-guides/assets/compressors/">Compressors</a>
              </li>
            
              
              <li>
              
                <a href="/hanami-guides/assets/content-delivery-network/">Content Delivery Network (CDN)</a>
              </li>
            
              
              <li>
              
                <a href="/hanami-guides/assets/use-your-own-assets-management-tool/">Use Your Own Assets Management</a>
              </li>
            
            </ul>
          
          
            <span class="ct-toc-link">Command Line</span>
            <ul class="nav ct-sidenav">
            
              
              <li>
              
                <a href="/hanami-guides/command-line/project/">Project</a>
              </li>
            
              
              <li>
              
                <a href="/hanami-guides/command-line/generators/">Generators</a>
              </li>
            
              
              <li>
              
                <a href="/hanami-guides/command-line/destroy/">Destroy</a>
              </li>
            
              
              <li>
              
                <a href="/hanami-guides/command-line/database/">Database</a>
              </li>
            
              
              <li>
              
                <a href="/hanami-guides/command-line/assets/">Assets</a>
              </li>
            
              
              <li>
              
                <a href="/hanami-guides/command-line/routes/">Routes</a>
              </li>
            
              
              <li>
              
                <a href="/hanami-guides/command-line/version/">Version</a>
              </li>
            
              
              <li>
              
                <a href="/hanami-guides/command-line/plugins/">Plugins</a>
              </li>
            
            </ul>
          
          
            <span class="ct-toc-link">Upgrade Notes</span>
            <ul class="nav ct-sidenav">
            
              
              <li>
              
                <a href="/hanami-guides/upgrade-notes/v060/">v0.6.0</a>
              </li>
            
              
              <li>
              
                <a href="/hanami-guides/upgrade-notes/v070/">v0.7.0</a>
              </li>
            
              
              <li>
              
                <a href="/hanami-guides/upgrade-notes/v080/">v0.8.0</a>
              </li>
            
              
              <li>
              
                <a href="/hanami-guides/upgrade-notes/v090/">v0.9.0</a>
              </li>
            
              
              <li>
              
                <a href="/hanami-guides/upgrade-notes/v100/">v1.0.0</a>
              </li>
            
              
              <li>
              
                <a href="/hanami-guides/upgrade-notes/v110/">v1.1.0</a>
              </li>
            
              
              <li>
              
                <a href="/hanami-guides/upgrade-notes/v120/">v1.2.0</a>
              </li>
            
              
              <li>
              
                <a href="/hanami-guides/upgrade-notes/v130/">v1.3.0</a>
              </li>
            
            </ul>
          
          </div>
        </nav>
      </div>
      <div class="d-none d-xl-block col-xl-2 ct-toc">
        <ul class="section-nav" id="secondary-navigation">
        
        
          
          
          <li class="toc-entry toc-h2">
            <a href="#unit-tests" class="nav-link">Unit Tests</a>
          </li>
        
          
          
          <li class="toc-entry toc-h2">
            <a href="#running-tests" class="nav-link">Running Tests</a>
          </li>
        
          
          
          <li class="toc-entry toc-h2">
            <a href="#params" class="nav-link">Params</a>
          </li>
        
          
          
          <li class="toc-entry toc-h2">
            <a href="#exposures" class="nav-link">Exposures</a>
          </li>
        
          
          
          <li class="toc-entry toc-h2">
            <a href="#dependency-injection" class="nav-link">Dependency Injection</a>
          </li>
        
          
          
          <li class="toc-entry toc-h2">
            <a href="#flash-messages" class="nav-link">Flash messages</a>
          </li>
        
          
          
          <li class="toc-entry toc-h2">
            <a href="#requests-tests" class="nav-link">Requests Tests</a>
          </li>
        
        </ul>
      </div>
      <main class="col-12 col-md-9 col-xl-8 py-md-3 pl-md-5 ct-content">
        <div class="ct-page-title">
          <h1 class="ct-title" id="content">Actions: Testing</h1>
          <div class="avatar-group mt-3">
          </div>
        </div>
        <hr>
        

<p>Hanami pays a lot of attention to code testability and it offers advanced features to make our lives easier.
The framework supports RSpec (default) and Minitest.</p>

<h2 id="unit-tests">Unit Tests</h2>

<p>First of all, actions can be unit tested.
That means we can instantiate, exercise and verify expectations <strong>directly on actions instances</strong>.</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#75715e"># spec/web/controllers/dashboard/index_spec.rb</span>
<span style="color:#111">require_relative</span> <span style="color:#d88200">&#39;../../../../apps/web/controllers/dashboard/index&#39;</span>

<span style="color:#00a8c8">RSpec</span><span style="color:#f92672">.</span><span style="color:#111">describe</span> <span style="color:#00a8c8">Web</span><span style="color:#f92672">::</span><span style="color:#00a8c8">Controllers</span><span style="color:#f92672">::</span><span style="color:#00a8c8">Dashboard</span><span style="color:#f92672">::</span><span style="color:#00a8c8">Index</span> <span style="color:#00a8c8">do</span>
  <span style="color:#111">let</span><span style="color:#111">(</span><span style="color:#d88200">:action</span><span style="color:#111">)</span> <span style="color:#111">{</span> <span style="color:#00a8c8">Web</span><span style="color:#f92672">::</span><span style="color:#00a8c8">Controllers</span><span style="color:#f92672">::</span><span style="color:#00a8c8">Dashboard</span><span style="color:#f92672">::</span><span style="color:#00a8c8">Index</span><span style="color:#f92672">.</span><span style="color:#111">new</span> <span style="color:#111">}</span>
  <span style="color:#111">let</span><span style="color:#111">(</span><span style="color:#d88200">:params</span><span style="color:#111">)</span> <span style="color:#111">{</span> <span style="color:#00a8c8">Hash</span><span style="color:#f92672">[]</span> <span style="color:#111">}</span>

  <span style="color:#111">it</span> <span style="color:#d88200">&#34;is successful&#34;</span> <span style="color:#00a8c8">do</span>
    <span style="color:#111">response</span> <span style="color:#f92672">=</span> <span style="color:#111">action</span><span style="color:#f92672">.</span><span style="color:#111">call</span><span style="color:#111">(</span><span style="color:#111">params</span><span style="color:#111">)</span>
    <span style="color:#111">expect</span><span style="color:#111">(</span><span style="color:#111">response</span><span style="color:#f92672">[</span><span style="color:#ae81ff">0</span><span style="color:#f92672">]</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">to</span> <span style="color:#111">be</span><span style="color:#111">(</span><span style="color:#ae81ff">200</span><span style="color:#111">)</span>
  <span style="color:#00a8c8">end</span>
<span style="color:#00a8c8">end</span></code></pre></div>
<p>In the example above, <code>action</code> is an instance of <code>Web::Controllers::Dashboard::Index</code>, we can invoke <code>#call</code> on it, passing a Hash of parameters.
The <a href="/guides/1.2/actions/rack-integration">implicit returning value</a> is a serialized Rack response.
We&rsquo;re asserting that the status code (<code>response[0]</code>) is successful (equals to <code>200</code>).</p>

<h2 id="running-tests">Running Tests</h2>

<p>We can run the entire test suite or a single file.</p>

<p>The default Rake task for the application serves for our first case: <code>bundle exec rake</code>.
All the dependencies and the application code (actions, views, entities, etc..) are eagerly loaded.
<strong>Boot time is slow in this case.</strong></p>

<p class="notice">
The entire test suite can be run via default Rake task. It loads all the dependencies, and the application code.
</p>

<p>The second scenario can be done via: <code>ruby -Ispec spec/web/controllers/dashboard/index_spec.rb</code> (or <code>rspec spec/web/controllers/dashboard/index_spec.rb</code> if we use RSpec).
When we run a single file example <strong>only the framework and the application settings are loaded</strong>.</p>

<p>Please note the <code>require_relative</code> line in the example.
It&rsquo;s <strong>auto generated for us</strong> and it&rsquo;s needed to load the current action under test.
This mechanism allows us to run unit tests in <strong>isolation</strong>.
<strong>Boot time is magnitudes faster</strong>.</p>

<p class="notice">
A single unit test can be run directly. It only loads the dependencies, but not the application code.
The class under test is loaded via <code>require_relative</code>, a line automatically generated for us.
In this way we can have a faster startup time and a shorter feedback cycle.
</p>

<h2 id="params">Params</h2>

<p>When testing an action, we can easily simulate parameters and headers coming from the request.
We just need to pass them as a Hash.
Headers for Rack env such as <code>HTTP_ACCEPT</code> can be mixed with params like <code>:id</code>.</p>

<p>The following test example uses both.</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#75715e"># spec/web/controllers/users/show_spec.rb</span>
<span style="color:#111">require_relative</span> <span style="color:#d88200">&#39;../../../../apps/web/controllers/users/show&#39;</span>

<span style="color:#00a8c8">RSpec</span><span style="color:#f92672">.</span><span style="color:#111">describe</span> <span style="color:#00a8c8">Web</span><span style="color:#f92672">::</span><span style="color:#00a8c8">Controllers</span><span style="color:#f92672">::</span><span style="color:#00a8c8">Users</span><span style="color:#f92672">::</span><span style="color:#00a8c8">Show</span> <span style="color:#00a8c8">do</span>
  <span style="color:#111">let</span><span style="color:#111">(</span><span style="color:#d88200">:action</span><span style="color:#111">)</span>  <span style="color:#111">{</span> <span style="color:#00a8c8">Web</span><span style="color:#f92672">::</span><span style="color:#00a8c8">Controllers</span><span style="color:#f92672">::</span><span style="color:#00a8c8">Users</span><span style="color:#f92672">::</span><span style="color:#00a8c8">Show</span><span style="color:#f92672">.</span><span style="color:#111">new</span> <span style="color:#111">}</span>
  <span style="color:#111">let</span><span style="color:#111">(</span><span style="color:#d88200">:format</span><span style="color:#111">)</span>  <span style="color:#111">{</span> <span style="color:#d88200">&#39;application/json&#39;</span> <span style="color:#111">}</span>
  <span style="color:#111">let</span><span style="color:#111">(</span><span style="color:#d88200">:user_id</span><span style="color:#111">)</span> <span style="color:#111">{</span> <span style="color:#d88200">&#39;23&#39;</span> <span style="color:#111">}</span>

  <span style="color:#111">it</span> <span style="color:#d88200">&#34;is successful&#34;</span> <span style="color:#00a8c8">do</span>
    <span style="color:#111">response</span> <span style="color:#f92672">=</span> <span style="color:#111">action</span><span style="color:#f92672">.</span><span style="color:#111">call</span><span style="color:#111">(</span><span style="color:#111">id</span><span style="color:#111">:</span> <span style="color:#111">user_id</span><span style="color:#111">,</span> <span style="color:#d88200">&#39;HTTP_ACCEPT&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#111">format</span><span style="color:#111">)</span>

    <span style="color:#111">expect</span><span style="color:#111">(</span><span style="color:#111">response</span><span style="color:#f92672">[</span><span style="color:#ae81ff">0</span><span style="color:#f92672">]</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">to</span>                 <span style="color:#111">eq</span><span style="color:#111">(</span><span style="color:#ae81ff">200</span><span style="color:#111">)</span>
    <span style="color:#111">expect</span><span style="color:#111">(</span><span style="color:#111">response</span><span style="color:#f92672">[</span><span style="color:#ae81ff">1</span><span style="color:#f92672">][</span><span style="color:#d88200">&#39;Content-Type&#39;</span><span style="color:#f92672">]</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">to</span> <span style="color:#111">eq</span><span style="color:#111">(</span><span style="color:#d88200">&#34;</span><span style="color:#d88200">#{</span> <span style="color:#111">format</span> <span style="color:#d88200">}</span><span style="color:#d88200">; charset=utf-8&#34;</span><span style="color:#111">)</span>
    <span style="color:#111">expect</span><span style="color:#111">(</span><span style="color:#111">response</span><span style="color:#f92672">[</span><span style="color:#ae81ff">2</span><span style="color:#f92672">]</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">to</span>                 <span style="color:#111">eq</span><span style="color:#111">(</span><span style="color:#f92672">[</span><span style="color:#d88200">&#34;ID: </span><span style="color:#d88200">#{</span> <span style="color:#111">user_id</span> <span style="color:#d88200">}</span><span style="color:#d88200">&#34;</span><span style="color:#f92672">]</span><span style="color:#111">)</span>
  <span style="color:#00a8c8">end</span>
<span style="color:#00a8c8">end</span></code></pre></div>
<p>Here the corresponding production code.</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#75715e"># apps/web/controllers/users/show.rb</span>
<span style="color:#00a8c8">module</span> <span style="color:#111">Web</span>
  <span style="color:#00a8c8">module</span> <span style="color:#111">Controllers</span>
    <span style="color:#00a8c8">module</span> <span style="color:#111">Users</span>
      <span style="color:#00a8c8">class</span> <span style="color:#75af00">Show</span>
        <span style="color:#00a8c8">include</span> <span style="color:#00a8c8">Web</span><span style="color:#f92672">::</span><span style="color:#00a8c8">Action</span>

        <span style="color:#00a8c8">def</span> <span style="color:#75af00">call</span><span style="color:#111">(</span><span style="color:#111">params</span><span style="color:#111">)</span>
          <span style="color:#111">puts</span> <span style="color:#111">params</span><span style="color:#f92672">.</span><span style="color:#111">class</span> <span style="color:#75715e"># =&gt; Web::Controllers::Users::Show::Params</span>
          <span style="color:#111">self</span><span style="color:#f92672">.</span><span style="color:#111">body</span> <span style="color:#f92672">=</span> <span style="color:#d88200">&#34;ID: </span><span style="color:#d88200">#{</span> <span style="color:#111">params</span><span style="color:#f92672">[</span><span style="color:#d88200">:id</span><span style="color:#f92672">]</span> <span style="color:#d88200">}</span><span style="color:#d88200">&#34;</span>
        <span style="color:#00a8c8">end</span>
      <span style="color:#00a8c8">end</span>
    <span style="color:#00a8c8">end</span>
  <span style="color:#00a8c8">end</span>
<span style="color:#00a8c8">end</span></code></pre></div>
<p class="notice">
Simulating request params and headers is simple for Hanami actions. We pass them as a <code>Hash</code> and they are transformed into an instance of <code>Hanami::Action::Params</code>.
</p>

<h2 id="exposures">Exposures</h2>

<p>There are cases where we want to verify the internal state of an action.
Imagine we have a classic user profile page, like depicted in the example above.
The action asks for a record that corresponds to the given id, and then set a <code>@user</code> instance variable.
How do we verify that the record is the one that we are looking for?</p>

<p>Because we want to make <code>@user</code> available to the outside world, we&rsquo;re going to use an <a href="/guides/1.2/actions/exposures"><em>exposure</em></a>.
They are used to pass a data payload between an action and the corresponding view.
When we do <code>expose :user</code>, Hanami creates a getter (<code>#user</code>), so we can easily assert if the record is the right one.</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#75715e"># apps/web/controllers/users/show.rb</span>
<span style="color:#00a8c8">module</span> <span style="color:#111">Web</span>
  <span style="color:#00a8c8">module</span> <span style="color:#111">Controllers</span>
    <span style="color:#00a8c8">module</span> <span style="color:#111">Users</span>
      <span style="color:#00a8c8">class</span> <span style="color:#75af00">Show</span>
        <span style="color:#00a8c8">include</span> <span style="color:#00a8c8">Web</span><span style="color:#f92672">::</span><span style="color:#00a8c8">Action</span>
        <span style="color:#111">expose</span> <span style="color:#d88200">:user</span><span style="color:#111">,</span> <span style="color:#d88200">:foo</span>

        <span style="color:#00a8c8">def</span> <span style="color:#75af00">call</span><span style="color:#111">(</span><span style="color:#111">params</span><span style="color:#111">)</span>
          <span style="color:#111">@user</span> <span style="color:#f92672">=</span> <span style="color:#00a8c8">UserRepository</span><span style="color:#f92672">.</span><span style="color:#111">new</span><span style="color:#f92672">.</span><span style="color:#111">find</span><span style="color:#111">(</span><span style="color:#111">params</span><span style="color:#f92672">[</span><span style="color:#d88200">:id</span><span style="color:#f92672">]</span><span style="color:#111">)</span>
          <span style="color:#111">@foo</span>  <span style="color:#f92672">=</span> <span style="color:#d88200">&#39;bar&#39;</span>
        <span style="color:#00a8c8">end</span>
      <span style="color:#00a8c8">end</span>
    <span style="color:#00a8c8">end</span>
  <span style="color:#00a8c8">end</span>
<span style="color:#00a8c8">end</span></code></pre></div>
<p>We have used two <em>exposures</em>: <code>:user</code> and <code>:foo</code>, let&rsquo;s verify if they are properly set.</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#75715e"># spec/web/controllers/users/show_spec.rb</span>
<span style="color:#111">require_relative</span> <span style="color:#d88200">&#39;../../../../apps/web/controllers/users/show&#39;</span>

<span style="color:#00a8c8">RSpec</span><span style="color:#f92672">.</span><span style="color:#111">describe</span> <span style="color:#00a8c8">Web</span><span style="color:#f92672">::</span><span style="color:#00a8c8">Controllers</span><span style="color:#f92672">::</span><span style="color:#00a8c8">Users</span><span style="color:#f92672">::</span><span style="color:#00a8c8">Show</span> <span style="color:#00a8c8">do</span>
  <span style="color:#111">let</span><span style="color:#111">(</span><span style="color:#d88200">:user</span><span style="color:#111">)</span> <span style="color:#111">{</span> <span style="color:#00a8c8">UserRepository</span><span style="color:#f92672">.</span><span style="color:#111">new</span><span style="color:#f92672">.</span><span style="color:#111">create</span><span style="color:#111">(</span><span style="color:#111">name</span><span style="color:#111">:</span> <span style="color:#d88200">&#39;Luca&#39;</span><span style="color:#111">)</span> <span style="color:#111">}</span>
  <span style="color:#111">let</span><span style="color:#111">(</span><span style="color:#d88200">:action</span><span style="color:#111">)</span>  <span style="color:#111">{</span> <span style="color:#00a8c8">Web</span><span style="color:#f92672">::</span><span style="color:#00a8c8">Controllers</span><span style="color:#f92672">::</span><span style="color:#00a8c8">Users</span><span style="color:#f92672">::</span><span style="color:#00a8c8">Show</span><span style="color:#f92672">.</span><span style="color:#111">new</span> <span style="color:#111">}</span>

  <span style="color:#111">it</span> <span style="color:#d88200">&#34;is successful&#34;</span> <span style="color:#00a8c8">do</span>
    <span style="color:#111">response</span> <span style="color:#f92672">=</span> <span style="color:#111">action</span><span style="color:#f92672">.</span><span style="color:#111">call</span><span style="color:#111">(</span><span style="color:#111">id</span><span style="color:#111">:</span> <span style="color:#111">user</span><span style="color:#f92672">.</span><span style="color:#111">id</span><span style="color:#111">)</span>

    <span style="color:#111">expect</span><span style="color:#111">(</span><span style="color:#111">response</span><span style="color:#f92672">[</span><span style="color:#ae81ff">0</span><span style="color:#f92672">]</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">to</span> <span style="color:#111">be</span><span style="color:#111">(</span><span style="color:#ae81ff">200</span><span style="color:#111">)</span>

    <span style="color:#111">action</span><span style="color:#f92672">.</span><span style="color:#111">user</span><span style="color:#f92672">.</span><span style="color:#111">must_equal</span> <span style="color:#111">user</span>
    <span style="color:#111">action</span><span style="color:#f92672">.</span><span style="color:#111">exposures</span><span style="color:#f92672">.</span><span style="color:#111">must_equal</span><span style="color:#111">({</span><span style="color:#d88200">user</span><span style="color:#111">:</span> <span style="color:#111">user</span><span style="color:#111">,</span> <span style="color:#d88200">foo</span><span style="color:#111">:</span> <span style="color:#d88200">&#39;bar&#39;</span><span style="color:#111">})</span>
  <span style="color:#00a8c8">end</span>
<span style="color:#00a8c8">end</span></code></pre></div>
<p class="notice">
The internal state of an action can be easily verified with <em>exposures</em>.
</p>

<h2 id="dependency-injection">Dependency Injection</h2>

<p>During unit testing, we may want to use mocks to make tests faster or to avoid hitting external systems like databases, file system or remote services.
Because we can instantiate actions during tests, there is no need to use testing antipatterns (eg. <code>any_instance_of</code>, or <code>UserRepository.new.stub(:find)</code>).
Instead, we can just specify which collaborators we want to use via <em>dependency injection</em>.</p>

<p>Let&rsquo;s rewrite the test above so that it does not hit the database.
We&rsquo;re going to use RSpec for this example as it has a nicer API for mocks (doubles).</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#75715e"># spec/web/controllers/users/show_spec.rb</span>
<span style="color:#111">require_relative</span> <span style="color:#d88200">&#39;../../../../apps/web/controllers/users/show&#39;</span>

<span style="color:#00a8c8">RSpec</span><span style="color:#f92672">.</span><span style="color:#111">describe</span> <span style="color:#00a8c8">Web</span><span style="color:#f92672">::</span><span style="color:#00a8c8">Controllers</span><span style="color:#f92672">::</span><span style="color:#00a8c8">Users</span><span style="color:#f92672">::</span><span style="color:#00a8c8">Show</span> <span style="color:#00a8c8">do</span>
  <span style="color:#111">let</span><span style="color:#111">(</span><span style="color:#d88200">:action</span><span style="color:#111">)</span>     <span style="color:#111">{</span> <span style="color:#00a8c8">Web</span><span style="color:#f92672">::</span><span style="color:#00a8c8">Controllers</span><span style="color:#f92672">::</span><span style="color:#00a8c8">Users</span><span style="color:#f92672">::</span><span style="color:#00a8c8">Show</span><span style="color:#f92672">.</span><span style="color:#111">new</span><span style="color:#111">(</span><span style="color:#d88200">repository</span><span style="color:#111">:</span> <span style="color:#111">repository</span><span style="color:#111">)</span> <span style="color:#111">}</span>
  <span style="color:#111">let</span><span style="color:#111">(</span><span style="color:#d88200">:user</span><span style="color:#111">)</span>       <span style="color:#111">{</span> <span style="color:#00a8c8">User</span><span style="color:#f92672">.</span><span style="color:#111">new</span><span style="color:#111">(</span><span style="color:#111">id</span><span style="color:#111">:</span> <span style="color:#ae81ff">23</span><span style="color:#111">,</span> <span style="color:#111">name</span><span style="color:#111">:</span> <span style="color:#d88200">&#39;Luca&#39;</span><span style="color:#111">)</span> <span style="color:#111">}</span>
  <span style="color:#111">let</span><span style="color:#111">(</span><span style="color:#d88200">:repository</span><span style="color:#111">)</span> <span style="color:#111">{</span> <span style="color:#111">double</span><span style="color:#111">(</span><span style="color:#d88200">&#39;repository&#39;</span><span style="color:#111">,</span> <span style="color:#d88200">find</span><span style="color:#111">:</span> <span style="color:#111">user</span><span style="color:#111">)</span> <span style="color:#111">}</span>

  <span style="color:#111">it</span> <span style="color:#d88200">&#34;is successful&#34;</span> <span style="color:#00a8c8">do</span>
    <span style="color:#111">response</span> <span style="color:#f92672">=</span> <span style="color:#111">action</span><span style="color:#f92672">.</span><span style="color:#111">call</span><span style="color:#111">(</span><span style="color:#111">id</span><span style="color:#111">:</span> <span style="color:#111">user</span><span style="color:#f92672">.</span><span style="color:#111">id</span><span style="color:#111">)</span>

    <span style="color:#111">expect</span><span style="color:#111">(</span><span style="color:#111">response</span><span style="color:#f92672">[</span><span style="color:#ae81ff">0</span><span style="color:#f92672">]</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">to</span>      <span style="color:#111">eq</span><span style="color:#111">(</span><span style="color:#ae81ff">200</span><span style="color:#111">)</span>
    <span style="color:#111">expect</span><span style="color:#111">(</span><span style="color:#111">action</span><span style="color:#f92672">.</span><span style="color:#111">user</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">to</span>      <span style="color:#111">eq</span><span style="color:#111">(</span><span style="color:#111">user</span><span style="color:#111">)</span>
    <span style="color:#111">expect</span><span style="color:#111">(</span><span style="color:#111">action</span><span style="color:#f92672">.</span><span style="color:#111">exposures</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">to</span> <span style="color:#111">eq</span><span style="color:#111">({</span><span style="color:#d88200">user</span><span style="color:#111">:</span> <span style="color:#111">user</span><span style="color:#111">})</span>
  <span style="color:#00a8c8">end</span>
<span style="color:#00a8c8">end</span></code></pre></div>
<p>We have injected the repository dependency which is a mock in our case.
Here how to adapt our action.</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#75715e"># apps/web/controllers/users/show.rb</span>
<span style="color:#00a8c8">module</span> <span style="color:#111">Web</span>
  <span style="color:#00a8c8">module</span> <span style="color:#111">Controllers</span>
    <span style="color:#00a8c8">module</span> <span style="color:#111">Users</span>
      <span style="color:#00a8c8">class</span> <span style="color:#75af00">Show</span>
        <span style="color:#00a8c8">include</span> <span style="color:#00a8c8">Web</span><span style="color:#f92672">::</span><span style="color:#00a8c8">Action</span>
        <span style="color:#111">expose</span> <span style="color:#d88200">:user</span>

        <span style="color:#00a8c8">def</span> <span style="color:#75af00">initialize</span><span style="color:#111">(</span><span style="color:#d88200">repository</span><span style="color:#111">:</span> <span style="color:#00a8c8">UserRepository</span><span style="color:#f92672">.</span><span style="color:#111">new</span><span style="color:#111">)</span>
          <span style="color:#111">@repository</span> <span style="color:#f92672">=</span> <span style="color:#111">repository</span>
        <span style="color:#00a8c8">end</span>

        <span style="color:#00a8c8">def</span> <span style="color:#75af00">call</span><span style="color:#111">(</span><span style="color:#111">params</span><span style="color:#111">)</span>
          <span style="color:#111">@user</span> <span style="color:#f92672">=</span> <span style="color:#111">@repository</span><span style="color:#f92672">.</span><span style="color:#111">find</span><span style="color:#111">(</span><span style="color:#111">params</span><span style="color:#f92672">[</span><span style="color:#d88200">:id</span><span style="color:#f92672">]</span><span style="color:#111">)</span>
        <span style="color:#00a8c8">end</span>
      <span style="color:#00a8c8">end</span>
    <span style="color:#00a8c8">end</span>
  <span style="color:#00a8c8">end</span>
<span style="color:#00a8c8">end</span></code></pre></div>
<p class="warning">
Please be careful using doubles in unit tests. Always verify that the mocks are in a true representation of the corresponding production code.
</p>

<h2 id="flash-messages">Flash messages</h2>

<p>In your action tests, you can check <code>flash</code> messages too. For this, you can use <code>exposures</code> method for getting all flash data.</p>

<p>The following test example uses this method.</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#75715e"># spec/web/controllers/users/create_spec.rb</span>
<span style="color:#111">require_relative</span> <span style="color:#d88200">&#39;../../../../apps/web/controllers/users/create&#39;</span>

<span style="color:#00a8c8">RSpec</span><span style="color:#f92672">.</span><span style="color:#111">describe</span> <span style="color:#00a8c8">Web</span><span style="color:#f92672">::</span><span style="color:#00a8c8">Controllers</span><span style="color:#f92672">::</span><span style="color:#00a8c8">Users</span><span style="color:#f92672">::</span><span style="color:#00a8c8">Create</span> <span style="color:#00a8c8">do</span>
  <span style="color:#111">let</span><span style="color:#111">(</span><span style="color:#d88200">:action</span><span style="color:#111">)</span>  <span style="color:#111">{</span> <span style="color:#00a8c8">Web</span><span style="color:#f92672">::</span><span style="color:#00a8c8">Controllers</span><span style="color:#f92672">::</span><span style="color:#00a8c8">Users</span><span style="color:#f92672">::</span><span style="color:#00a8c8">Create</span><span style="color:#f92672">.</span><span style="color:#111">new</span> <span style="color:#111">}</span>
  <span style="color:#111">let</span><span style="color:#111">(</span><span style="color:#d88200">:user_params</span><span style="color:#111">)</span> <span style="color:#111">{</span> <span style="color:#111">name</span><span style="color:#111">:</span> <span style="color:#d88200">&#39;Luca&#39;</span> <span style="color:#111">}</span>

  <span style="color:#111">it</span> <span style="color:#d88200">&#34;is successful&#34;</span> <span style="color:#00a8c8">do</span>
    <span style="color:#111">response</span> <span style="color:#f92672">=</span> <span style="color:#111">action</span><span style="color:#f92672">.</span><span style="color:#111">call</span><span style="color:#111">(</span><span style="color:#111">id</span><span style="color:#111">:</span> <span style="color:#111">user_params</span><span style="color:#111">)</span>
    <span style="color:#111">flash</span> <span style="color:#f92672">=</span> <span style="color:#111">action</span><span style="color:#f92672">.</span><span style="color:#111">exposures</span><span style="color:#f92672">[</span><span style="color:#d88200">:flash</span><span style="color:#f92672">]</span>

    <span style="color:#111">expect</span><span style="color:#111">(</span><span style="color:#111">flash</span><span style="color:#f92672">[</span><span style="color:#d88200">:info</span><span style="color:#f92672">]</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">to</span> <span style="color:#111">eq</span><span style="color:#111">(</span><span style="color:#d88200">&#39;User was successfully created&#39;</span><span style="color:#111">)</span>
  <span style="color:#00a8c8">end</span>
<span style="color:#00a8c8">end</span></code></pre></div>
<h2 id="requests-tests">Requests Tests</h2>

<p>Unit tests are a great tool to assert that low level interfaces work as expected.
We always advise combining them with integration tests.</p>

<p>In the case of Hanami web applications, we can write features (aka acceptance tests) with Capybara, but what do we use when we are building HTTP APIs?
The tool that we suggest is <code>rack-test</code>.</p>

<p>Imagine we have an API application mounted at <code>/api/v1</code> in our <code>Hanami::Container</code>.</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#75715e"># config/environment.rb</span>
<span style="color:#75715e"># ...</span>
<span style="color:#00a8c8">Hanami</span><span style="color:#f92672">::</span><span style="color:#00a8c8">Container</span><span style="color:#f92672">.</span><span style="color:#111">configure</span> <span style="color:#00a8c8">do</span>
  <span style="color:#111">mount</span> <span style="color:#00a8c8">ApiV1</span><span style="color:#f92672">::</span><span style="color:#00a8c8">Application</span><span style="color:#111">,</span> <span style="color:#d88200">at</span><span style="color:#111">:</span> <span style="color:#d88200">&#39;/api/v1&#39;</span>
  <span style="color:#111">mount</span> <span style="color:#00a8c8">Web</span><span style="color:#f92672">::</span><span style="color:#00a8c8">Application</span><span style="color:#111">,</span>   <span style="color:#d88200">at</span><span style="color:#111">:</span> <span style="color:#d88200">&#39;/&#39;</span>
<span style="color:#00a8c8">end</span></code></pre></div>
<p>Then we have the following action.</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#75715e"># apps/api_v1/controllers/users/show.rb</span>
<span style="color:#00a8c8">module</span> <span style="color:#111">ApiV1</span>
  <span style="color:#00a8c8">module</span> <span style="color:#111">Controllers</span>
    <span style="color:#00a8c8">module</span> <span style="color:#111">Users</span>
      <span style="color:#00a8c8">class</span> <span style="color:#75af00">Show</span>
        <span style="color:#00a8c8">include</span> <span style="color:#00a8c8">ApiV1</span><span style="color:#f92672">::</span><span style="color:#00a8c8">Action</span>
        <span style="color:#111">accept</span> <span style="color:#d88200">:json</span>

        <span style="color:#00a8c8">def</span> <span style="color:#75af00">call</span><span style="color:#111">(</span><span style="color:#111">params</span><span style="color:#111">)</span>
          <span style="color:#111">user</span> <span style="color:#f92672">=</span> <span style="color:#00a8c8">UserRepository</span><span style="color:#f92672">.</span><span style="color:#111">new</span><span style="color:#f92672">.</span><span style="color:#111">find</span><span style="color:#111">(</span><span style="color:#111">params</span><span style="color:#f92672">[</span><span style="color:#d88200">:id</span><span style="color:#f92672">]</span><span style="color:#111">)</span>
          <span style="color:#111">self</span><span style="color:#f92672">.</span><span style="color:#111">body</span> <span style="color:#f92672">=</span> <span style="color:#00a8c8">JSON</span><span style="color:#f92672">.</span><span style="color:#111">generate</span><span style="color:#111">(</span><span style="color:#111">user</span><span style="color:#f92672">.</span><span style="color:#111">to_h</span><span style="color:#111">)</span>
        <span style="color:#00a8c8">end</span>
      <span style="color:#00a8c8">end</span>
    <span style="color:#00a8c8">end</span>
  <span style="color:#00a8c8">end</span>
<span style="color:#00a8c8">end</span></code></pre></div>
<p>In this case we don&rsquo;t care too much about the internal state of the action, but about the output visible to the external world.
This is why we haven&rsquo;t set <code>user</code> as an instance variable and why we haven&rsquo;t exposed it.</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#75715e"># spec/api_v1/requests/users_spec.rb</span>
<span style="color:#00a8c8">RSpec</span><span style="color:#f92672">.</span><span style="color:#111">describe</span> <span style="color:#d88200">&#34;API V1 users&#34;</span> <span style="color:#00a8c8">do</span>
  <span style="color:#00a8c8">include</span> <span style="color:#00a8c8">Rack</span><span style="color:#f92672">::</span><span style="color:#00a8c8">Test</span><span style="color:#f92672">::</span><span style="color:#00a8c8">Methods</span>

  <span style="color:#75715e"># app is required by Rack::Test</span>
  <span style="color:#111">let</span><span style="color:#111">(</span><span style="color:#d88200">:app</span><span style="color:#111">)</span> <span style="color:#111">{</span> <span style="color:#00a8c8">Hanami</span><span style="color:#f92672">.</span><span style="color:#111">app</span> <span style="color:#111">}</span>
  <span style="color:#111">let</span><span style="color:#111">(</span><span style="color:#d88200">:user</span><span style="color:#111">)</span> <span style="color:#111">{</span> <span style="color:#00a8c8">UserRepository</span><span style="color:#f92672">.</span><span style="color:#111">new</span><span style="color:#f92672">.</span><span style="color:#111">create</span><span style="color:#111">(</span><span style="color:#111">name</span><span style="color:#111">:</span> <span style="color:#d88200">&#39;Luca&#39;</span><span style="color:#111">)</span> <span style="color:#111">}</span>

  <span style="color:#111">it</span> <span style="color:#d88200">&#34;is successful&#34;</span> <span style="color:#00a8c8">do</span>
    <span style="color:#111">get</span> <span style="color:#d88200">&#34;/api/v1/users/</span><span style="color:#d88200">#{</span> <span style="color:#111">user</span><span style="color:#f92672">.</span><span style="color:#111">id</span> <span style="color:#d88200">}</span><span style="color:#d88200">&#34;</span>

    <span style="color:#111">expect</span><span style="color:#111">(</span><span style="color:#111">last_response</span><span style="color:#f92672">.</span><span style="color:#111">status</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">to</span> <span style="color:#111">be</span><span style="color:#111">(</span><span style="color:#ae81ff">200</span><span style="color:#111">)</span>
    <span style="color:#111">expect</span><span style="color:#111">(</span><span style="color:#111">last_response</span><span style="color:#f92672">.</span><span style="color:#111">body</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">to</span> <span style="color:#111">eq</span><span style="color:#111">(</span><span style="color:#00a8c8">JSON</span><span style="color:#f92672">.</span><span style="color:#111">generate</span><span style="color:#111">(</span><span style="color:#111">user</span><span style="color:#f92672">.</span><span style="color:#111">to_h</span><span style="color:#111">))</span>
  <span style="color:#00a8c8">end</span>
<span style="color:#00a8c8">end</span></code></pre></div>
<p class="notice">
Please avoid <em>test doubles</em> when writing full integration tests, as we want to verify that the whole stack is behaving as expected.
</p>
<hr>
        <div class="container">
          <div class="row">
            <div class="col">
              
              <a href="/hanami-guides/actions/share-code/">
                <button class="btn btn-icon btn-3 btn-outline-primary" type="button">
                  <span class="btn-inner--icon"><i class="ni ni-bold-left"></i></span>
                  <span class="btn-inner--text">Actions: Share Code</span>
                </button>
              </a>
              
            </div>
            <div class="col text-align-right">
              
              <a href="/hanami-guides/views/overview/">
                <button class="btn btn-icon btn-3 btn-outline-primary" type="button">
                  <span class="btn-inner--text">Views: Overview</span>
                  <span class="btn-inner--icon"><i class="ni ni-bold-right"></i></span>
                </button>
              </a>
              
            </div>
          </div>
        </div>
      </main>
    </div>
  </div>
  
  <script src="/hanami-guides/assets/vendor/jquery/jquery.min.js"></script>
  <script src="/hanami-guides/assets/vendor/popper/popper.min.js"></script>
  <script src="/hanami-guides/assets/vendor/bootstrap/bootstrap.min.js"></script>
  <script src="/hanami-guides/assets/vendor/headroom/headroom.min.js"></script>
  <script src="/hanami-guides/assets/vendor/clipboard/clipboard.min.js"></script>
  
  <script src="/hanami-guides/assets/js/argon.js?v=1.0.1"></script>
  <script src="/hanami-guides/assets/js/theme.js"></script>
  
  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.js"></script>
  <script type="text/javascript"> docsearch({
    apiKey: '69274449268769eb3878f6a13dd112f9',
    indexName: 'hanamirb_guides',
    inputSelector: '#search-input',
    debug: false 
  });
  </script>
  
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-41951932-2', 'auto');
	
	ga('send', 'pageview');
}
</script>

  </body>
</html>
